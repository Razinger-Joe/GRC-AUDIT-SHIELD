import { useState } from "react";
import { DashboardLayout } from "@/components/layout/DashboardLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Checkbox } from "@/components/ui/checkbox";
import { Switch } from "@/components/ui/switch";
import { Progress } from "@/components/ui/progress";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  Drawer,
  DrawerClose,
  DrawerContent,
  DrawerDescription,
  DrawerFooter,
  DrawerHeader,
  DrawerTitle,
} from "@/components/ui/drawer";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Separator } from "@/components/ui/separator";
import { Label } from "@/components/ui/label";
import { Slider } from "@/components/ui/slider";
import {
  Skull,
  AlertTriangle,
  AlertCircle,
  Info,
  Play,
  Calendar,
  Upload,
  RefreshCw,
  X,
  ExternalLink,
  FileDown,
  Search,
  Zap,
  Clock,
  CheckCircle2,
  Settings,
  Shield,
  Server,
  Globe,
  Database,
  Loader2,
} from "lucide-react";
import { cn } from "@/lib/utils";
import { toast } from "@/components/ui/use-toast";

// Mock vulnerability data
const mockVulnerabilities = [
  {
    id: "CVE-2024-21762",
    name: "FortiOS SSL VPN Remote Code Execution",
    severity: "Critical",
    cvssScore: 9.8,
    affectedAssets: ["FW-PROD-01", "FW-PROD-02", "FW-DR-01"],
    assetCount: 3,
    exploitability: "In the wild",
    age: 45,
    status: "In Progress",
    patchAvailable: true,
    complianceImpact: ["PCI-DSS", "SOC 2"],
    description: "A out-of-bounds write vulnerability in FortiOS SSL VPN may allow a remote unauthenticated attacker to execute arbitrary code or command via specially crafted requests.",
    cvssVector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
    references: ["CWE-787", "MITRE ATT&CK T1190"],
    remediation: {
      patch: "Upgrade to FortiOS 7.4.3 or later",
      workaround: "Disable SSL VPN functionality if not required",
      estimatedDowntime: "30 minutes per device",
      rollbackPlan: "Maintain backup of current configuration",
    },
    timeline: [
      { date: "2024-01-02", event: "CVE Published" },
      { date: "2024-01-05", event: "Detected in environment" },
      { date: "2024-01-08", event: "Patch testing started" },
      { date: "2024-01-15", event: "Production patching scheduled" },
    ],
  },
  {
    id: "CVE-2024-3400",
    name: "PAN-OS Command Injection Vulnerability",
    severity: "Critical",
    cvssScore: 10.0,
    affectedAssets: ["PA-5250-01"],
    assetCount: 1,
    exploitability: "In the wild",
    age: 12,
    status: "Not Started",
    patchAvailable: true,
    complianceImpact: ["HIPAA", "PCI-DSS", "SOC 2"],
    description: "A command injection vulnerability in the GlobalProtect feature of Palo Alto Networks PAN-OS software.",
    cvssVector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H",
    references: ["CWE-77", "MITRE ATT&CK T1059"],
    remediation: {
      patch: "Apply PAN-OS hotfix or upgrade to 10.2.9-h1",
      workaround: "Apply Threat Prevention signature 95187",
      estimatedDowntime: "45 minutes",
      rollbackPlan: "Export current config before upgrade",
    },
    timeline: [
      { date: "2024-01-20", event: "CVE Published" },
      { date: "2024-01-22", event: "Detected in environment" },
    ],
  },
  {
    id: "CVE-2023-44487",
    name: "HTTP/2 Rapid Reset Attack",
    severity: "High",
    cvssScore: 7.5,
    affectedAssets: ["WEB-PROD-01", "WEB-PROD-02", "WEB-PROD-03", "API-GW-01"],
    assetCount: 4,
    exploitability: "PoC exists",
    age: 90,
    status: "Completed",
    patchAvailable: true,
    complianceImpact: ["SOC 2"],
    description: "The HTTP/2 protocol allows a denial of service through rapid reset attacks.",
    cvssVector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
    references: ["CWE-400", "MITRE ATT&CK T1499"],
    remediation: {
      patch: "Update web server and load balancer software",
      workaround: "Implement rate limiting on HTTP/2 connections",
      estimatedDowntime: "15 minutes with rolling restart",
      rollbackPlan: "Keep previous version containers ready",
    },
    timeline: [
      { date: "2023-10-10", event: "CVE Published" },
      { date: "2023-10-15", event: "Detected in environment" },
      { date: "2023-10-25", event: "Patches applied" },
      { date: "2023-10-26", event: "Verified remediated" },
    ],
  },
  {
    id: "CVE-2024-1234",
    name: "OpenSSL Buffer Overflow",
    severity: "Medium",
    cvssScore: 5.3,
    affectedAssets: ["DB-PROD-01", "DB-PROD-02"],
    assetCount: 2,
    exploitability: "Theoretical",
    age: 20,
    status: "In Progress",
    patchAvailable: true,
    complianceImpact: [],
    description: "A buffer overflow vulnerability in OpenSSL affecting TLS handshake processing.",
    cvssVector: "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H",
    references: ["CWE-120"],
    remediation: {
      patch: "Upgrade OpenSSL to 3.1.5",
      workaround: "None available",
      estimatedDowntime: "5 minutes per server",
      rollbackPlan: "Snapshot before update",
    },
    timeline: [
      { date: "2024-01-10", event: "CVE Published" },
      { date: "2024-01-12", event: "Detected in environment" },
      { date: "2024-01-18", event: "Patch testing in progress" },
    ],
  },
  {
    id: "CVE-2024-5678",
    name: "Docker Container Escape",
    severity: "Low",
    cvssScore: 3.3,
    affectedAssets: ["K8S-NODE-01", "K8S-NODE-02", "K8S-NODE-03", "K8S-NODE-04", "K8S-NODE-05"],
    assetCount: 5,
    exploitability: "Theoretical",
    age: 5,
    status: "Auto-Fixed",
    patchAvailable: true,
    complianceImpact: [],
    description: "A container escape vulnerability in Docker daemon versions prior to 24.0.7.",
    cvssVector: "CVSS:3.1/AV:L/AC:H/PR:L/UI:R/S:U/C:L/I:L/A:N",
    references: ["CWE-269"],
    remediation: {
      patch: "Update Docker to 24.0.7 or later",
      workaround: "Run containers with --security-opt no-new-privileges",
      estimatedDowntime: "Node drain and restart",
      rollbackPlan: "Previous Docker version in package cache",
    },
    timeline: [
      { date: "2024-01-19", event: "CVE Published" },
      { date: "2024-01-20", event: "Detected in environment" },
      { date: "2024-01-20", event: "Auto-remediation triggered" },
      { date: "2024-01-21", event: "Verified remediated" },
    ],
  },
];

const severityConfig = {
  Critical: { icon: Skull, color: "text-destructive", bg: "bg-destructive/10", badge: "bg-destructive" },
  High: { icon: AlertTriangle, color: "text-orange-500", bg: "bg-orange-500/10", badge: "bg-orange-500" },
  Medium: { icon: AlertCircle, color: "text-warning", bg: "bg-warning/10", badge: "bg-warning text-warning-foreground" },
  Low: { icon: Info, color: "text-info", bg: "bg-info/10", badge: "bg-info" },
};

const statusConfig = {
  "Not Started": { color: "bg-muted text-muted-foreground" },
  "In Progress": { color: "bg-warning/20 text-warning" },
  "Completed": { color: "bg-success/20 text-success" },
  "Auto-Fixed": { color: "bg-primary/20 text-primary" },
};

const VulnerabilityManagement = () => {
  const [scanning, setScanning] = useState(false);
  const [scanProgress, setScanProgress] = useState(0);
  const [assetsScanned, setAssetsScanned] = useState(0);
  const [selectedVuln, setSelectedVuln] = useState<typeof mockVulnerabilities[0] | null>(null);
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [configDialogOpen, setConfigDialogOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");
  const [severityFilters, setSeverityFilters] = useState<string[]>(["Critical", "High", "Medium", "Low"]);
  const [statusFilters, setStatusFilters] = useState<string[]>(["Not Started", "In Progress", "Completed", "Auto-Fixed"]);
  const [exploitedOnly, setExploitedOnly] = useState(false);

  const handleStartScan = () => {
    setScanning(true);
    setScanProgress(0);
    setAssetsScanned(0);
    
    const interval = setInterval(() => {
      setScanProgress((prev) => {
        if (prev >= 100) {
          clearInterval(interval);
          setScanning(false);
          toast({
            title: "Scan Complete",
            description: "Found 5 vulnerabilities across 15 assets",
          });
          return 100;
        }
        setAssetsScanned(Math.floor((prev / 100) * 453));
        return prev + 2;
      });
    }, 100);
  };

  const handleCancelScan = () => {
    setScanning(false);
    setScanProgress(0);
  };

  const toggleSeverityFilter = (severity: string) => {
    setSeverityFilters((prev) =>
      prev.includes(severity) ? prev.filter((s) => s !== severity) : [...prev, severity]
    );
  };

  const filteredVulns = mockVulnerabilities.filter((vuln) => {
    const matchesSearch = vuln.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
      vuln.id.toLowerCase().includes(searchQuery.toLowerCase());
    const matchesSeverity = severityFilters.includes(vuln.severity);
    const matchesStatus = statusFilters.includes(vuln.status);
    const matchesExploited = !exploitedOnly || vuln.exploitability === "In the wild";
    return matchesSearch && matchesSeverity && matchesStatus && matchesExploited;
  });

  const criticalCount = mockVulnerabilities.filter((v) => v.severity === "Critical").length;
  const highCount = mockVulnerabilities.filter((v) => v.severity === "High").length;
  const mediumLowCount = mockVulnerabilities.filter((v) => v.severity === "Medium" || v.severity === "Low").length;
  const slaCompliance = 78;
  const autoRemediationRate = 92;

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">Vulnerability Management</h1>
            <p className="text-muted-foreground">
              Last scan: Today at 09:15 AM
              <Button variant="ghost" size="sm" className="ml-2 h-6 px-2">
                <RefreshCw className="h-3 w-3" />
              </Button>
            </p>
          </div>
          <div className="flex gap-2 flex-wrap">
            <Button onClick={handleStartScan} disabled={scanning}>
              <Play className="mr-2 h-4 w-4" />
              Run New Scan
            </Button>
            <Button variant="outline">
              <Calendar className="mr-2 h-4 w-4" />
              Schedule Scan
            </Button>
            <Button variant="outline">
              <Upload className="mr-2 h-4 w-4" />
              Import Results
            </Button>
          </div>
        </div>

        {/* Scan Progress */}
        {scanning && (
          <Card className="glass-card border-primary/50 animate-pulse-glow">
            <CardContent className="py-4">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-3">
                  <Loader2 className="h-5 w-5 text-primary animate-spin" />
                  <span className="font-medium">Scanning in progress...</span>
                </div>
                <Button variant="ghost" size="sm" onClick={handleCancelScan}>
                  <X className="h-4 w-4 mr-1" />
                  Cancel
                </Button>
              </div>
              <Progress value={scanProgress} className="h-2 mb-2" />
              <div className="flex justify-between text-sm text-muted-foreground">
                <span>{assetsScanned}/453 assets scanned</span>
                <span>{scanProgress}%</span>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Stats Cards */}
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-5">
          <Card className={cn("glass-card", criticalCount > 0 && "border-destructive/50 animate-pulse")}>
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium">Critical</CardTitle>
              <Skull className="h-5 w-5 text-destructive" />
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-destructive">{criticalCount}</div>
            </CardContent>
          </Card>

          <Card className="glass-card">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium">High</CardTitle>
              <AlertTriangle className="h-5 w-5 text-orange-500" />
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-orange-500">{highCount}</div>
            </CardContent>
          </Card>

          <Card className="glass-card">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium">Medium / Low</CardTitle>
              <AlertCircle className="h-5 w-5 text-warning" />
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-warning">{mediumLowCount}</div>
            </CardContent>
          </Card>

          <Card className="glass-card">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium">SLA Compliance</CardTitle>
              <Clock className="h-5 w-5 text-primary" />
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{slaCompliance}%</div>
            </CardContent>
          </Card>

          <Card className="glass-card">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium">Auto-Remediation</CardTitle>
              <Zap className="h-5 w-5 text-success" />
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold text-success">{autoRemediationRate}%</div>
            </CardContent>
          </Card>
        </div>

        <div className="grid gap-6 lg:grid-cols-4">
          {/* Filters Panel */}
          <Card className="glass-card lg:col-span-1">
            <CardHeader>
              <CardTitle className="text-sm">Filters</CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
              <div>
                <Label className="text-xs text-muted-foreground mb-2 block">Severity</Label>
                <div className="space-y-2">
                  {["Critical", "High", "Medium", "Low"].map((severity) => (
                    <div key={severity} className="flex items-center space-x-2">
                      <Checkbox
                        id={severity}
                        checked={severityFilters.includes(severity)}
                        onCheckedChange={() => toggleSeverityFilter(severity)}
                      />
                      <label htmlFor={severity} className="text-sm cursor-pointer">
                        {severity}
                      </label>
                    </div>
                  ))}
                </div>
              </div>

              <Separator />

              <div>
                <Label className="text-xs text-muted-foreground mb-2 block">Remediation Status</Label>
                <div className="space-y-2">
                  {["Not Started", "In Progress", "Completed", "Auto-Fixed"].map((status) => (
                    <div key={status} className="flex items-center space-x-2">
                      <Checkbox
                        id={status}
                        checked={statusFilters.includes(status)}
                        onCheckedChange={() => setStatusFilters((prev) =>
                          prev.includes(status) ? prev.filter((s) => s !== status) : [...prev, status]
                        )}
                      />
                      <label htmlFor={status} className="text-sm cursor-pointer">
                        {status}
                      </label>
                    </div>
                  ))}
                </div>
              </div>

              <Separator />

              <div className="flex items-center justify-between">
                <Label htmlFor="exploited" className="text-sm">Actively Exploited</Label>
                <Switch
                  id="exploited"
                  checked={exploitedOnly}
                  onCheckedChange={setExploitedOnly}
                />
              </div>

              <Separator />

              <Dialog open={configDialogOpen} onOpenChange={setConfigDialogOpen}>
                <DialogTrigger asChild>
                  <Button variant="outline" size="sm" className="w-full">
                    <Settings className="mr-2 h-4 w-4" />
                    Auto-Remediation Config
                  </Button>
                </DialogTrigger>
                <DialogContent>
                  <DialogHeader>
                    <DialogTitle>Auto-Remediation Configuration</DialogTitle>
                    <DialogDescription>
                      Configure automatic patching settings for your environment.
                    </DialogDescription>
                  </DialogHeader>
                  <div className="space-y-6 py-4">
                    <div className="space-y-3">
                      <Label>Enable Auto-Patch by Severity</Label>
                      <div className="space-y-2">
                        <div className="flex items-center justify-between">
                          <span className="text-sm">Low Severity</span>
                          <Switch defaultChecked />
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-sm">Medium Severity</span>
                          <Switch defaultChecked />
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-sm">High Severity</span>
                          <Switch />
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-sm">Critical Severity</span>
                          <Switch />
                        </div>
                      </div>
                    </div>

                    <Separator />

                    <div className="space-y-3">
                      <Label>Approval Required Threshold (CVSS Score)</Label>
                      <Slider defaultValue={[7]} max={10} step={0.1} />
                      <p className="text-xs text-muted-foreground">
                        Vulnerabilities with CVSS â‰¥ 7.0 require manual approval
                      </p>
                    </div>

                    <Separator />

                    <div className="space-y-2">
                      <Label>Maintenance Window</Label>
                      <p className="text-sm text-muted-foreground">Sunday 02:00 - 06:00 UTC</p>
                      <Button variant="outline" size="sm">Configure Window</Button>
                    </div>
                  </div>
                </DialogContent>
              </Dialog>
            </CardContent>
          </Card>

          {/* Vulnerability Table */}
          <div className="lg:col-span-3 space-y-4">
            <div className="flex items-center gap-4">
              <div className="relative flex-1">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder="Search by CVE or name..."
                  className="pl-9"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
              </div>
              <Button variant="outline" size="sm">
                <FileDown className="mr-2 h-4 w-4" />
                Export
              </Button>
            </div>

            <Card className="glass-card">
              <ScrollArea className="h-[600px]">
                <Table>
                  <TableHeader>
                    <TableRow className="hover:bg-transparent">
                      <TableHead className="w-[50px]">Sev</TableHead>
                      <TableHead>CVE ID</TableHead>
                      <TableHead>Vulnerability</TableHead>
                      <TableHead>Assets</TableHead>
                      <TableHead>CVSS</TableHead>
                      <TableHead>Exploitability</TableHead>
                      <TableHead>Age</TableHead>
                      <TableHead>Status</TableHead>
                      <TableHead>Patch</TableHead>
                      <TableHead>Actions</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {filteredVulns.map((vuln) => {
                      const SevIcon = severityConfig[vuln.severity as keyof typeof severityConfig].icon;
                      const sevColor = severityConfig[vuln.severity as keyof typeof severityConfig].color;
                      const sevBadge = severityConfig[vuln.severity as keyof typeof severityConfig].badge;

                      return (
                        <TableRow
                          key={vuln.id}
                          className="cursor-pointer hover:bg-muted/50"
                          onClick={() => {
                            setSelectedVuln(vuln);
                            setDrawerOpen(true);
                          }}
                        >
                          <TableCell>
                            <SevIcon className={cn("h-5 w-5", sevColor)} />
                          </TableCell>
                          <TableCell>
                            <a
                              href={`https://nvd.nist.gov/vuln/detail/${vuln.id}`}
                              target="_blank"
                              rel="noopener noreferrer"
                              onClick={(e) => e.stopPropagation()}
                              className="font-mono text-primary hover:underline flex items-center gap-1"
                            >
                              {vuln.id}
                              <ExternalLink className="h-3 w-3" />
                            </a>
                          </TableCell>
                          <TableCell className="max-w-[200px] truncate font-medium">
                            {vuln.name}
                          </TableCell>
                          <TableCell>
                            <Badge variant="outline">{vuln.assetCount} assets</Badge>
                          </TableCell>
                          <TableCell>
                            <div className="flex items-center gap-1">
                              <span className={cn("font-bold", sevColor)}>{vuln.cvssScore}</span>
                              <span className="text-xs text-muted-foreground">v3.1</span>
                            </div>
                          </TableCell>
                          <TableCell>
                            <Badge variant={vuln.exploitability === "In the wild" ? "destructive" : "secondary"}>
                              {vuln.exploitability}
                            </Badge>
                          </TableCell>
                          <TableCell>
                            <span className={cn(vuln.age > 30 && "text-destructive font-medium")}>
                              {vuln.age}d
                            </span>
                          </TableCell>
                          <TableCell>
                            <Badge className={statusConfig[vuln.status as keyof typeof statusConfig].color}>
                              {vuln.status}
                            </Badge>
                          </TableCell>
                          <TableCell>
                            {vuln.patchAvailable ? (
                              <CheckCircle2 className="h-4 w-4 text-success" />
                            ) : (
                              <X className="h-4 w-4 text-muted-foreground" />
                            )}
                          </TableCell>
                          <TableCell>
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={(e) => {
                                e.stopPropagation();
                                toast({
                                  title: "Auto-remediation triggered",
                                  description: `Patching ${vuln.id} on ${vuln.assetCount} assets`,
                                });
                              }}
                            >
                              <Zap className="h-4 w-4" />
                            </Button>
                          </TableCell>
                        </TableRow>
                      );
                    })}
                  </TableBody>
                </Table>
              </ScrollArea>
            </Card>
          </div>
        </div>

        {/* Vulnerability Detail Drawer */}
        <Drawer open={drawerOpen} onOpenChange={setDrawerOpen}>
          <DrawerContent className="max-h-[90vh]">
            <DrawerHeader>
              <DrawerTitle className="flex items-center gap-2">
                {selectedVuln?.id}
                <Badge className={severityConfig[selectedVuln?.severity as keyof typeof severityConfig]?.badge}>
                  {selectedVuln?.severity}
                </Badge>
                <Badge variant="outline">CVSS {selectedVuln?.cvssScore}</Badge>
              </DrawerTitle>
              <DrawerDescription>{selectedVuln?.name}</DrawerDescription>
            </DrawerHeader>

            <ScrollArea className="flex-1 px-4">
              <Tabs defaultValue="overview" className="pb-6">
                <TabsList className="grid w-full grid-cols-5">
                  <TabsTrigger value="overview">Overview</TabsTrigger>
                  <TabsTrigger value="assets">Assets</TabsTrigger>
                  <TabsTrigger value="remediation">Remediation</TabsTrigger>
                  <TabsTrigger value="context">Risk Context</TabsTrigger>
                  <TabsTrigger value="timeline">Timeline</TabsTrigger>
                </TabsList>

                <TabsContent value="overview" className="space-y-4 mt-4">
                  <div>
                    <h4 className="text-sm font-semibold mb-2">Description</h4>
                    <p className="text-sm text-muted-foreground">{selectedVuln?.description}</p>
                  </div>

                  <div>
                    <h4 className="text-sm font-semibold mb-2">CVSS Vector</h4>
                    <code className="text-xs bg-muted px-2 py-1 rounded">{selectedVuln?.cvssVector}</code>
                  </div>

                  <div>
                    <h4 className="text-sm font-semibold mb-2">References</h4>
                    <div className="flex gap-2">
                      {selectedVuln?.references.map((ref) => (
                        <Badge key={ref} variant="outline">{ref}</Badge>
                      ))}
                    </div>
                  </div>

                  {selectedVuln?.complianceImpact && selectedVuln.complianceImpact.length > 0 && (
                    <div className="p-3 rounded-lg bg-warning/10 border border-warning/20">
                      <h4 className="text-sm font-semibold mb-2 flex items-center gap-2">
                        <Shield className="h-4 w-4 text-warning" />
                        Compliance Impact
                      </h4>
                      <div className="flex gap-2">
                        {selectedVuln.complianceImpact.map((framework) => (
                          <Badge key={framework} className="bg-warning text-warning-foreground">
                            {framework}
                          </Badge>
                        ))}
                      </div>
                    </div>
                  )}
                </TabsContent>

                <TabsContent value="assets" className="mt-4">
                  <div className="space-y-2">
                    {selectedVuln?.affectedAssets.map((asset) => (
                      <div key={asset} className="flex items-center justify-between p-3 rounded-lg bg-muted/30">
                        <div className="flex items-center gap-3">
                          <Server className="h-4 w-4 text-muted-foreground" />
                          <span className="font-mono">{asset}</span>
                        </div>
                        <Badge variant="outline">Production</Badge>
                      </div>
                    ))}
                  </div>
                </TabsContent>

                <TabsContent value="remediation" className="space-y-4 mt-4">
                  <div className="p-4 rounded-lg bg-primary/10 border border-primary/20">
                    <h4 className="text-sm font-semibold mb-2">Recommended Patch</h4>
                    <p className="text-sm">{selectedVuln?.remediation.patch}</p>
                  </div>

                  <div>
                    <h4 className="text-sm font-semibold mb-2">Workaround</h4>
                    <p className="text-sm text-muted-foreground">{selectedVuln?.remediation.workaround}</p>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <h4 className="text-sm font-semibold mb-1">Estimated Downtime</h4>
                      <p className="text-sm text-muted-foreground">{selectedVuln?.remediation.estimatedDowntime}</p>
                    </div>
                    <div>
                      <h4 className="text-sm font-semibold mb-1">Rollback Plan</h4>
                      <p className="text-sm text-muted-foreground">{selectedVuln?.remediation.rollbackPlan}</p>
                    </div>
                  </div>
                </TabsContent>

                <TabsContent value="context" className="mt-4">
                  <div className="p-4 rounded-lg bg-muted/30">
                    <h4 className="text-sm font-semibold mb-2">AI Recommendation</h4>
                    <p className="text-sm text-muted-foreground">
                      Based on asset criticality and active exploitation in the wild, immediate patching is recommended.
                      Compensating controls (WAF rules) are in place providing partial mitigation.
                    </p>
                  </div>
                </TabsContent>

                <TabsContent value="timeline" className="mt-4">
                  <div className="space-y-4">
                    {selectedVuln?.timeline.map((event, idx) => (
                      <div key={idx} className="flex gap-3">
                        <div className="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center shrink-0">
                          <Clock className="h-4 w-4 text-primary" />
                        </div>
                        <div>
                          <p className="text-sm font-medium">{event.event}</p>
                          <p className="text-xs text-muted-foreground">{event.date}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                </TabsContent>
              </Tabs>
            </ScrollArea>

            <DrawerFooter className="flex-row gap-2">
              <Button variant="outline" className="flex-1">Accept Risk</Button>
              <Button variant="outline" className="flex-1">Create Ticket</Button>
              <Button className="flex-1">
                <Zap className="mr-2 h-4 w-4" />
                Auto-Remediate
              </Button>
              <DrawerClose asChild>
                <Button variant="ghost">Close</Button>
              </DrawerClose>
            </DrawerFooter>
          </DrawerContent>
        </Drawer>
      </div>
    </DashboardLayout>
  );
};

export default VulnerabilityManagement;
