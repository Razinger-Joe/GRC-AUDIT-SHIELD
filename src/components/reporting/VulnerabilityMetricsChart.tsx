import React from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import {
    BarChart,
    Bar,
    XAxis,
    YAxis,
    CartesianGrid,
    Tooltip,
    ResponsiveContainer,
    Legend,
    PieChart,
    Pie,
    Cell,
    LineChart,
    Line,
} from "recharts";
import { TrendingDown, Clock, AlertTriangle, CheckCircle2 } from "lucide-react";

// MTTR Trend Data
const mttrData = [
    { month: "Jul", critical: 2.1, high: 5.2, medium: 12.4, low: 28.5 },
    { month: "Aug", critical: 1.8, high: 4.8, medium: 11.2, low: 25.3 },
    { month: "Sep", critical: 1.5, high: 4.2, medium: 10.1, low: 22.1 },
    { month: "Oct", critical: 1.3, high: 3.8, medium: 9.5, low: 20.8 },
    { month: "Nov", critical: 1.1, high: 3.5, medium: 8.8, low: 18.2 },
    { month: "Dec", critical: 0.9, high: 3.2, medium: 8.1, low: 16.5 },
];

// Vulnerability Severity Distribution
const severityData = [
    { name: "Critical", value: 12, color: "#ef4444" },
    { name: "High", value: 34, color: "#f97316" },
    { name: "Medium", value: 67, color: "#eab308" },
    { name: "Low", value: 89, color: "#22c55e" },
];

// Open vs Closed Trend
const openClosedData = [
    { month: "Jul", opened: 45, closed: 38 },
    { month: "Aug", opened: 52, closed: 48 },
    { month: "Sep", opened: 38, closed: 55 },
    { month: "Oct", opened: 41, closed: 62 },
    { month: "Nov", opened: 35, closed: 58 },
    { month: "Dec", opened: 28, closed: 45 },
];

export const VulnerabilityMetricsChart = () => {
    const totalVulns = severityData.reduce((sum, s) => sum + s.value, 0);
    const criticalCount = severityData.find(s => s.name === "Critical")?.value || 0;
    const avgMTTR = 4.2; // days
    const remediationRate = 87;

    return (
        <div className="space-y-6">
            {/* KPI Cards */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <Card className="glass-card">
                    <CardContent className="pt-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-muted-foreground">Total Open</p>
                                <p className="text-2xl font-bold">{totalVulns}</p>
                            </div>
                            <AlertTriangle className="h-8 w-8 text-warning opacity-80" />
                        </div>
                    </CardContent>
                </Card>
                <Card className="glass-card border-destructive/30">
                    <CardContent className="pt-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-muted-foreground">Critical</p>
                                <p className="text-2xl font-bold text-destructive">{criticalCount}</p>
                            </div>
                            <Badge variant="destructive" className="animate-pulse">Urgent</Badge>
                        </div>
                    </CardContent>
                </Card>
                <Card className="glass-card">
                    <CardContent className="pt-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-muted-foreground">Avg MTTR</p>
                                <p className="text-2xl font-bold">{avgMTTR}d</p>
                            </div>
                            <Clock className="h-8 w-8 text-info opacity-80" />
                        </div>
                        <p className="text-xs text-success mt-1 flex items-center gap-1">
                            <TrendingDown className="h-3 w-3" /> 15% faster
                        </p>
                    </CardContent>
                </Card>
                <Card className="glass-card">
                    <CardContent className="pt-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm text-muted-foreground">Remediation Rate</p>
                                <p className="text-2xl font-bold text-success">{remediationRate}%</p>
                            </div>
                            <CheckCircle2 className="h-8 w-8 text-success opacity-80" />
                        </div>
                    </CardContent>
                </Card>
            </div>

            {/* Charts Row */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Severity Distribution */}
                <Card className="glass-card">
                    <CardHeader>
                        <CardTitle className="text-lg">Severity Distribution</CardTitle>
                        <CardDescription>Current open vulnerabilities by severity</CardDescription>
                    </CardHeader>
                    <CardContent className="h-[280px]">
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                                <Pie
                                    data={severityData}
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={60}
                                    outerRadius={100}
                                    paddingAngle={3}
                                    dataKey="value"
                                    label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                                    labelLine={false}
                                >
                                    {severityData.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={entry.color} />
                                    ))}
                                </Pie>
                                <Tooltip
                                    contentStyle={{
                                        backgroundColor: "hsl(var(--card))",
                                        borderColor: "hsl(var(--border))",
                                        borderRadius: "8px"
                                    }}
                                />
                            </PieChart>
                        </ResponsiveContainer>
                    </CardContent>
                </Card>

                {/* Open vs Closed Trend */}
                <Card className="glass-card">
                    <CardHeader>
                        <CardTitle className="text-lg">Open vs Closed Trend</CardTitle>
                        <CardDescription>Monthly vulnerability discovery and remediation</CardDescription>
                    </CardHeader>
                    <CardContent className="h-[280px]">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={openClosedData}>
                                <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
                                <XAxis dataKey="month" />
                                <YAxis />
                                <Tooltip
                                    contentStyle={{
                                        backgroundColor: "hsl(var(--card))",
                                        borderColor: "hsl(var(--border))",
                                        borderRadius: "8px"
                                    }}
                                />
                                <Legend />
                                <Bar dataKey="opened" fill="#ef4444" name="Opened" radius={[4, 4, 0, 0]} />
                                <Bar dataKey="closed" fill="#22c55e" name="Closed" radius={[4, 4, 0, 0]} />
                            </BarChart>
                        </ResponsiveContainer>
                    </CardContent>
                </Card>
            </div>

            {/* MTTR Trend */}
            <Card className="glass-card">
                <CardHeader>
                    <CardTitle className="text-lg">Mean Time to Remediation (MTTR) Trends</CardTitle>
                    <CardDescription>Average days to remediate vulnerabilities by severity over the past 6 months</CardDescription>
                </CardHeader>
                <CardContent className="h-[300px]">
                    <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={mttrData}>
                            <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
                            <XAxis dataKey="month" />
                            <YAxis label={{ value: 'Days', angle: -90, position: 'insideLeft' }} />
                            <Tooltip
                                contentStyle={{
                                    backgroundColor: "hsl(var(--card))",
                                    borderColor: "hsl(var(--border))",
                                    borderRadius: "8px"
                                }}
                            />
                            <Legend />
                            <Line type="monotone" dataKey="critical" stroke="#ef4444" strokeWidth={2} dot={{ r: 4 }} name="Critical" />
                            <Line type="monotone" dataKey="high" stroke="#f97316" strokeWidth={2} dot={{ r: 4 }} name="High" />
                            <Line type="monotone" dataKey="medium" stroke="#eab308" strokeWidth={2} dot={{ r: 4 }} name="Medium" />
                            <Line type="monotone" dataKey="low" stroke="#22c55e" strokeWidth={2} dot={{ r: 4 }} name="Low" />
                        </LineChart>
                    </ResponsiveContainer>
                </CardContent>
            </Card>
        </div>
    );
};

export default VulnerabilityMetricsChart;
